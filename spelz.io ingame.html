<!DOCTYPE html>
<html>
<head>
	<title>Spelz.io</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<style>
		html, body {
			height: 100%;
			margin: 0;
		}

		button {
			height: 100px;
			width: 100px;
		}

		div {
			border: 1px solid blue;
		}

		#mycanvas {
			border: 1px solid #d3d3d3;
			background-color: #f1f1f1;
			position: absolute;
			z-index: -1;
		}

		#startGameMenu {
			border: 1px solid blue;
			position: absolute;
			z-index: 1;
			height: calc(100% - 7px);
			width: calc(100% - 7px);
			display: flex;
			flex-direction: row;
			justify-content: space-between;
			align-content: flex-start;
			padding: 2px;
		}
        #inputUserName {
           width:500px;
		   height:50px;
        }

		.spelzio {
			margin: 0;
			font-size: 180px;
		}

		.notstart {
			width: 100px;
			height: 70px;
			margin: 3px;
		}

		.containera {
			display: flex;
			flex-direction: column;
			justify-content: space-between;
		}

		.item1a {
			text-align: center;
			margin: 2px;
		}

		.item2a {
			text-align: start;
			margin: 2px;
			padding: 0px;
			font-size: 25px;
		}

		.containerb {
			display: flex;
			flex-direction: column;
			justify-content: center;
			flex-grow: 1;
			margin: 2px;
		}

		.item1b {
			margin: 10px;
			text-align: center;
			margin: 2px;
			font-size: 40px;
		}

		.containerc {
			text-align: end;
			margin: 2px;
			padding: 2px 10px 2px 10px;
		}
	</style>
</head>
<body>
	<canvas id="mycanvas"></canvas>
	<div id="startGameMenu">
		<div class="containera">
			<div class="item1a">
				<button class="notstart">settings</button>
				<button class="notstart">changelog</button>
			</div>
			<div class="item2a">
				<button class="notstart">friends</button><br>
				<button class="notstart">spelz</button><br>
				<button class="notstart">monster gallery</button>
			</div>
		</div>
		<div class="containerb">
			<div class="item1b">
				<h1 class="spelzio">spelz.io</h1>				
				<input id="inputUserName" type="text" placeholder="Name" />
				<button id="startGameButton" onclick="startGame()">start game</button>				
			</div>
		</div>
		<div class="containerc">
			<a href="signin.html">sign in</a>
		</div>		
	</div>
	<script type="text/javascript" src="js/mob.js"></script>
	<script type="text/javascript" src="js/playable-character.js"></script>
	<script type="text/javascript" src="js/spellbook.js"></script>
	<script>
		let mobArray = [];
		let spellBooks;
		let maxSpellBooks = 3;
		var pi = 3.14159;

		var myGameArea = {
			activeButtons: [],
			activeKeys: [],
			validKeys: [37, 38, 39, 40, 65, 68, 83, 87, 97, 100, 119, 115, 32, 16],
			canvas: document.getElementById("mycanvas"),
			start: function () {
				this.context = this.canvas.getContext("2d");
				this.interval = setInterval(updateGameArea, 20);
				window.addEventListener('keydown', function (e) {
					var isKeyActive = myGameArea.activeKeys.indexOf(e.keyCode) >= 0;
					if (!isKeyActive) {
						var isValidKey = myGameArea.validKeys.indexOf(e.keyCode) >= 0;
						if (isValidKey) {
							myGameArea.activeKeys.push(e.keyCode);
						}
					}
					console.log(myGameArea.activeKeys);
					console.log("keydown");
				});
				window.addEventListener('keyup', function (e) {
					var keyIndex = myGameArea.activeKeys.indexOf(e.keyCode);
					var isKeyActive = keyIndex >= 0;
					if (isKeyActive) {
						myGameArea.activeKeys.splice(keyIndex, 1);
					}
					console.log(myGameArea.activeKeys);
					console.log("keyup");
				});
//lets you use mouse buttons
//				this.canvas.addEventListener("mousedown", function (e) {
//					var isButtonActive = myGameArea.activeButtons.indexOf(e.button) >= 0;
//					if (!isButtonActive) {
//						myGameArea.activeButtons.push(e.button);
//					}
//					console.log(myGameArea.activeButtons);
//					console.log("mousedown");
//				});
			},
			clear: function () {
				this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
			},
			stop: function () {
				clearInterval(this.interval);
			}
		}
		function startGame() {
			myGameCharacter = new PlayableCharacter(300, 300, 15, "yellow", 150, 10);
			mobArray.push(new Mob(200, 200, 30, "red", 30, 1));
			mobArray.push(new Mob(400, 400, 30, "red", 30, 1));
			myGameArea.start();
			myGameCharacter.update();
			mobArray.forEach(item => {
				item.update();
			});
			spellBooksKeeper();
			var startGameMenuVariable = document.getElementById("startGameMenu");
			startGameMenuVariable.remove();
		}

		function spellBooksKeeper() {
			spellBooks = [];
			spellBooks.push(new SpellBook(myGameCharacter.x, myGameCharacter.y, 10, 'gray', 45, 20, 70, 1, 1, 1500));
			spellBooks.push(new SpellBook(myGameCharacter.x, myGameCharacter.y, 10, 'gray', 45, 20, 70, 1, 1, 1500));
			spellBooks.push(new SpellBook(myGameCharacter.x, myGameCharacter.y, 10, 'gray', 45, 20, 70, 1, 1, 1500));
			for (var i = 0; i < spellBooks.length; i++) {
				if (i > 0)
					spellBooks[i].radian = ((i * pi) / maxSpellBooks) * 2;

				console.log(spellBooks[i].radian);
			}
		}
		function spellBooksUpdater() {
			spellBooks.forEach(spellBook => {
				spellBook.startingPos = {
					x: myGameCharacter.x,
					y: myGameCharacter.y
				}
				if (spellBook.orbitRadius < spellBook.normalOrbitRadius) {
					spellBook.orbitRadius += 1;
				}
				else if (spellBook.orbitRadius > spellBook.normalOrbitRadius) {
					spellBook.orbitRadius -= 1;
				}
				spellBook.update();
			});
		}
		function updateGameArea() {
// always updating		
            myGameArea.clear();
            myGameArea.context.canvas.width = window.innerWidth - 3;
			myGameArea.context.canvas.height = window.innerHeight - 3;    
			spellBooksUpdater();
			myGameCharacter.update();
            mobArray.forEach(mob => {
                mob.update();
            });
// death
			if (crashWith(myGameCharacter, mobArray)) {
				myGameArea.activeKeys = [];
				mobArray = [];
				spellBooks = [];
				alert("game over");
				myGameArea.stop();
				startGame();
			}
// hitting a mob
			else if (crashWithSpellBook(spellBooks, mobArray)) {
				myGameCharacter.x += myGameCharacter.speedX;
				myGameCharacter.y += myGameCharacter.speedY;
			}
//not moving anything
			else if ((myGameArea.activeKeys.length == 0) && (myGameArea.activeButtons.length == 0)) {		
				spellBooks.forEach(spellBook => {
					spellBook.color = 'gray';
				});
				return;
			}
//updates when moving
			else {				
				myGameCharacter.x += myGameCharacter.speedX;
				myGameCharacter.y += myGameCharacter.speedY;
			}
			myGameCharacter.speedX = 0;
			myGameCharacter.speedY = 0;
			var gameSpeed = myGameCharacter.speed;

			for (var i = 0; i < myGameArea.activeKeys.length; i++) {
				var key = myGameArea.activeKeys[i];

				if ((key == 37 || key == 65 || key == 97) && (myGameCharacter.speedX > -gameSpeed)) {
					myGameCharacter.speedX -= gameSpeed;
				}
				if ((key == 39 || key == 68 || key == 100) && (myGameCharacter.speedX < gameSpeed)) {
					myGameCharacter.speedX += gameSpeed;
				}
				if ((key == 38 || key == 87 || key == 119) && (myGameCharacter.speedY > -gameSpeed)) {
					myGameCharacter.speedY -= gameSpeed;
				}
				if ((key == 40 || key == 83 || key == 115) && (myGameCharacter.speedY < gameSpeed)) {
					myGameCharacter.speedY += gameSpeed;
				}
				if (key == 32) {
					spellBooks.forEach(spellBook => {
						if (spellBook.orbitRadius < spellBook.attackOrbitRadius) {
							spellBook.orbitRadius += 2;
							spellBook.color = 'red';
						}
					});
				}
				if (key == 16) {
					spellBooks.forEach(spellBook => {
						if (spellBook.orbitRadius > spellBook.defendOrbitRadius) {
							spellBook.orbitRadius -= 2;
							spellBook.color = 'green';
						}
					});
				}
			}
// failed attempt to making projectiles
//			for (var n = 0; n < myGameArea.activeButtons.length; n++) {
//				var button = myGameArea.activeButtons[n];
//				if (button == 0) {
//					spellBooks[0].velocity = 0;
//					console.log("Left mouse button is clicked");
//					if (spellBooks[0].orbitRadius < 500) {
//						spellBooks[0].orbitRadius += 7;
//						console.log(spellBooks[0].orbitRadius);
//					}
//					else if ((spellBooks[0].orbitRadius >= 500) || (spellBooks[0].health <= 0)) {
//						spellBooks.splice(0, 1);
//						myGameArea.activeButtons.splice(i, 1);
//						setTimeout(function () {
//							let spellBook1Radian = 0;
//							if (spellBooks.length > 0) {
//								spellBook1Radian = spellBooks[0].radian;
//							}
//							let newSpellBook = new SpellBook(myGameCharacter.x, myGameCharacter.y, 10, 'gray', 45, 20, 70, 1, 1, 1500);
//							let radianMultiplier = (pi / maxSpellBooks) * 2;
//							if (spellBooks.length > 0) {
//								newSpellBook.radian = spellBook1Radian + (radianMultiplier * spellBooks.length);
//							}
//							else {
//								newSpellBook.radian = 0;
//							}
//							spellBooks.push(newSpellBook);
//						},
//							spellBooks[0].respawnTime
//						);
//					}
//				}
//				else if (button == 1) {
//					console.log("middle mouse button is clicked");
//					myGameArea.activeButtons.splice(i, 1);
//				}
//				else if (button == 2) {
//					console.log("Right mouse button is clicked");
//					myGameArea.activeButtons.splice(i, 1);
//				}
//			}
		}
		function crashWith(spellBook, mobs) {
			let result = false;
			mobs.forEach(mob => {
				let radii = spellBook.radius + mob.radius;
				let distance = getDistance(spellBook, mob);
				let hasCrashed = distance < radii;
				if (hasCrashed) {
					result = hasCrashed;
				}
			});
			return result;
		}
		function crashWithSpellBook(spellBooks, mobs) {
			let result = false;
			spellBooks.forEach(spellBook => {
				var mobIndex = 0;
				mobs.forEach(mob => {
					let radii = spellBook.radius + mob.radius;
					let distance = getDistance(spellBook, mob);
					let hasCrashed = distance < radii;
					if (hasCrashed) {
						result = hasCrashed;
						mob.health -= spellBook.damage;
						mob.radius -= spellBook.damage;
						spellBook.health -= mob.damage
						console.log("mob health: " + mob.health);
						if (mob.health <= 0) {
							mobs.splice(mobIndex, 1);
							setTimeout(function () {
								if (mobArray.length >= 1) {
									let mobRandomX = Math.floor((Math.random() * 600) + 10);
									let mobRandomY = Math.floor((Math.random() * 600) + 10);
									let mobRandomRadiusXHealth = Math.floor((Math.random() * 100) + 10);
									let newMob = new Mob(mobRandomX, mobRandomY, mobRandomRadiusXHealth, "red", mobRandomRadiusXHealth, 1);
									mobArray.push(newMob);
								}
							},
								5000
                            );
						}
						else if (spellBook.health <= 0) {
							var spellBookIndex = spellBooks.indexOf(spellBook);
							spellBooks.splice(spellBookIndex, 1);
							setTimeout(function () {
								let spellBook1Radian = 0;
								if (spellBooks.length > 0) {
									spellBook1Radian = spellBooks[0].radian;
								}
								let newSpellBook = new SpellBook(myGameCharacter.x, myGameCharacter.y, 10, 'gray', 45, 20, 70, 1, 1, 1500);
								let radianMultiplier = (pi / maxSpellBooks) * 2;
								if (spellBooks.length > 0) {
									newSpellBook.radian = spellBook1Radian + (radianMultiplier * spellBooks.length);
								}
								else {
									newSpellBook.radian = 0;
								}
								spellBooks.push(newSpellBook);
							},
								spellBook.respawnTime
							);
						}
						mob.update();
					}
					mobIndex++;
				});
			});
			return result;
		}
		function getDistance(circle1, circle2) {
			let a = circle2.y - circle1.y;
			let b = circle2.x - circle1.x;
			return Math.sqrt(Math.pow(a, 2) + Math.pow(b, 2));
		}
		/*	task of the week:
		1). add fire guided projectile
		2). transfer mob to basicMob
		3). fix deprecated keycode				
		4). make it easier to add petals / make a shortcut for adding petals		
		5). make a stable radian var for all spell books	
		
		*/
	</script>
</body>
</html>
